id: Cortex XDR Alerts Handling v2
version: -1
name: Cortex XDR Alerts Handling v2
description: "This playbook is used to loop over every alert in a Cortex XDR incident. \nSupported alert categories:\n- Malware\n- Port Scan\n- Cloud Cryptojacking\n- Cloud Token Theft\n- RDP Brute-Force\n- First SSO Access\n- Cloud IAM User Access Investigation\n- Identity Analytics\n- Malicious Pod."
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 42f27e72-959d-4e01-8adf-c00187510762
    type: start
    task:
      id: 42f27e72-959d-4e01-8adf-c00187510762
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "1"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 80
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "1":
    id: "1"
    taskid: 42e4ac28-c6d4-4f0b-8cdb-4edcd684ca92
    type: condition
    task:
      id: 42e4ac28-c6d4-4f0b-8cdb-4edcd684ca92
      version: -1
      name: Choose playbook by category
      description: Choose the playbook to run by the alert category.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      ' Remote PsExec with LOLBIN command':
      - "18"
      '#default#':
      - "7"
      Cloud:
      - "11"
      First SSO Access:
      - "14"
      Identity Analytics:
      - "19"
      Large Upload:
      - "20"
      Malware:
      - "9"
      Port Scan:
      - "8"
      RDP Brute-Force:
      - "13"
      Masquerading:
      - "24"
    separatecontext: false
    conditions:
    - label: Masquerading
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                accessor: Incident.alerts.mitre_technique_id_and_name
            iscontext: true
          right:
            value:
              simple: T1036
          ignorecase: true
        - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                    ignorecase: true
                accessor: mitre_technique_id_and_name
            iscontext: true
          right:
            value:
              simple: Masquerading
          ignorecase: true
    - label: Port Scan
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                accessor: Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Port Scan
          ignorecase: true
    - label: Identity Analytics
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                accessor: tags
            iscontext: true
          right:
            value:
              simple: DT:Identity Analytics
          ignorecase: true
    - label: Cloud
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: incident.xdralerts
                accessor: event_type
            iscontext: true
          right:
            value:
              simple: Cloud Audit Log
        - operator: isEqualString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.module_id
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection
          ignorecase: true
    - label: RDP Brute-Force
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                accessor: name
            iscontext: true
          right:
            value:
              simple: Possible external RDP Brute-Force
    - label: First SSO Access
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                    ignorecase: true
                accessor: name
            iscontext: true
          right:
            value:
              simple: First SSO access from ASN in organization
        - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                    ignorecase: true
                accessor: name
            iscontext: true
          right:
            value:
              simple: First successful SSO connection from a country in organization
    - label: ' Remote PsExec with LOLBIN command'
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                accessor: name
            iscontext: true
          right:
            value:
              simple: Remote PsExec-like LOLBIN command execution from an unsigned non-standard PsExec service
          ignorecase: true
    - label: Large Upload
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                    ignorecase: true
                accessor: name
            iscontext: true
          right:
            value:
              simple: Large Upload
          ignorecase: true
    - label: Malware
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                      iscontext: true
                    right:
                      value:
                        simple: inputs.alert_id
                      iscontext: true
                    ignorecase: true
                accessor: category
            iscontext: true
          right:
            value:
              simple: Malware
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 210
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "5":
    id: "5"
    taskid: 3bfb5821-8d6a-4809-8b8e-e8aed054e2df
    type: title
    task:
      id: 3bfb5821-8d6a-4809-8b8e-e8aed054e2df
      version: -1
      name: Done
      type: title
      iscommand: false
      brand: ""
      description: ''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 480,
          "y": 930
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "7":
    id: "7"
    taskid: 7359b4be-b4e2-4ae1-8974-99679135918b
    type: title
    task:
      id: 7359b4be-b4e2-4ae1-8974-99679135918b
      version: -1
      name: Other alert category
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "21"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2670,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "8":
    id: "8"
    taskid: c7b238f5-0fe4-4f49-8102-795e468badf0
    type: playbook
    task:
      id: c7b238f5-0fe4-4f49-8102-795e468badf0
      version: -1
      name: Cortex XDR - Port Scan - Adjusted
      description: "The playbook investigates Cortex XDR incidents involving port scan alerts. The playbook is designed to run as a sub-playbook of ‘Cortex XDR Alerts Handling’. \n\nThe playbook consists of the following procedures:\n- Enrichment and investigation of the scanner and scanned hostname and IP address.\n- Enrichment and investigation of the initiator user, process, file, or command if it exists.\n- Detection of related indicators and analysis of the relationship between the detected indicators.\n- Utilize the detected indicators to conduct threat hunting.\n- Blocks detected malicious indicators.\n- Endpoint isolation.\n\nThis playbook supports the following Cortex XDR alert names:\n- Suspicious port scan\n- Port scan by suspicious process\n- Highly suspicious port scan\n- Port scan."
      playbookName: Cortex XDR - Port Scan - Adjusted
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AutoBlockIndicators:
        simple: "True"
      AutoIsolateEndpoint:
        simple: "False"
      DstIPAddress:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: action_remote_ip
          transformers:
          - operator: uniq
      DstPort:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: action_remote_port
          transformers:
          - operator: uniq
      EarlyContainment:
        simple: "True"
      EndpointID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: port scan
              ignorecase: true
          accessor: endpoint_id
          transformers:
          - operator: uniq
      Initiator_CMD:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: action_process_image_command_line
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.causality_actor_process_command_line
                iscontext: true
          - operator: uniq
      Initiator_Process_SHA256:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: action_process_image_sha256
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.causality_actor_process_image_sha256
                iscontext: true
          - operator: uniq
      InternalIPRanges:
        complex:
          root: inputs.InternalIPRanges
      SrcHostname:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: host_name
          transformers:
          - operator: append
            args:
              item:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_external_hostname
                iscontext: true
          - operator: uniq
      SrcIPAddress:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: action_local_ip
          transformers:
          - operator: uniq
      Username:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: user_name
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 920,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "9":
    id: "9"
    taskid: 2872f0e4-d709-49d3-80af-6dd12a3df5c2
    type: playbook
    task:
      id: 2872f0e4-d709-49d3-80af-6dd12a3df5c2
      version: -1
      name: Cortex XDR - Malware Investigation
      description: |
        Investigates a Cortex XDR incident containing internal malware alerts. The playbook:
        - Enriches the infected endpoint details.
        - Lets the analyst manually retrieve the malicious file.
        - Performs file detonation.

        The playbook is used as a sub-playbook in 'Cortex XDR Incident Handling - v2'.
      playbookName: Cortex XDR - Malware Investigation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "21"
    scriptarguments:
      endpoint_id:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: endpoint_id
      file_name:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: in
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_file_name
                iscontext: true
              right:
                value:
                  simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_name
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: action_file_name
      file_path:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: action_file_path
      file_sha256:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: in
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.action_file_sha256
                iscontext: true
              right:
                value:
                  simple: PaloAltoNetworksXDR.Incident.file_artifacts.file_sha256
                iscontext: true
              ignorecase: true
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: action_file_sha256
      host_ip:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: host_ip_list
      xdr_alert_id:
        complex:
          root: inputs.alert_id
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 2240,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 78e1842a-1098-401d-8a24-e1027c821fe7
    type: playbook
    task:
      id: 78e1842a-1098-401d-8a24-e1027c821fe7
      version: -1
      name: Cortex XDR - XCloud Cryptojacking
      description: "Investigates a Cortex XDR incident containing a Cloud Cryptojacking related alert. \nThe playbook supports AWS, Azure, and GCP and executes the following:\n\n- Cloud enrichment:\n   - Collects info about the involved resources\n   - Collects info about the involved identities\n   - Collects info about the involved IPs\n- Verdict decision tree\n- Verdict handling:\n   - Handle False Positives\n   - Handle True Positives\n      - Cloud Response - Generic sub-playbook.\n- Notifies the SOC if a malicious verdict was found"
      playbookName: Cortex XDR - XCloud Cryptojacking
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AWS-accessKeyRemediationType:
        simple: Disable
      AWS-resourceRemediationType:
        simple: Stop
      AWS-userRemediationType:
        simple: Revoke
      Azure-resourceRemediationType:
        simple: Poweroff
      Azure-userRemediationType:
        simple: Disable
      GCP-accessKeyRemediationType:
        simple: Disable
      GCP-resourceRemediationType:
        simple: Stop
      GCP-userRemediationType:
        simple: Disable
      InternalRange:
        complex:
          root: inputs.InternalIPRanges
      ResolveIP:
        simple: "True"
      alert_id:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: Unusual allocation of multiple cloud compute resources
              ignorecase: true
          accessor: alert_id
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
      cloudProvider:
        complex:
          root: PaloAltoNetworksXDR.OriginalAlert.event
          accessor: cloud_provider
      incident_id:
        complex:
          root: inputs.incident_id
      requireAnalystReview:
        simple: "True"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "11":
    id: "11"
    taskid: 8c27d20c-81bc-40e2-8419-cf4c7f62e1e0
    type: playbook
    task:
      id: 8c27d20c-81bc-40e2-8419-cf4c7f62e1e0
      version: -1
      name: GenericPolling
      description: |-
        Use this playbook as a sub-playbook to block execution of the master playbook until a remote action is complete.
        This playbook implements polling by continuously running the command in Step \#2 until the operation completes.
        The remote action should have the following structure:

        1. Initiate the operation.
        2. Poll to check if the operation completed.
        3. (optional) Get the results of the operation.
      playbookName: GenericPolling
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "12"
    scriptarguments:
      Ids:
        simple: ${incident.xdrincidentid}
      Interval:
        simple: "1"
      PollingCommandArgName:
        simple: incident_id
      PollingCommandName:
        simple: 'xdr-get-incident-extra-data '
      Timeout:
        simple: "3"
      dt:
        simple: PaloAltoNetworksXDR.Incident.alerts.name(val.name!=='Unusual allocation of multiple cloud compute resources')
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 405
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 7c235606-d71d-4132-8273-0529058c00e5
    type: condition
    task:
      id: 7c235606-d71d-4132-8273-0529058c00e5
      version: -1
      name: Which XCLOUD alert was found?
      description: Checks which XCLOUD alert was found in the incident.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      Cryptojacking:
      - "10"
      Data Exfiltration:
      - "17"
      IAM User Access:
      - "15"
      Malicious Pod:
      - "23"
      Token Theft:
      - "16"
    separatecontext: false
    conditions:
    - label: Cryptojacking
      condition:
      - - operator: containsGeneral
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                accessor: name
            iscontext: true
          right:
            value:
              simple: Unusual allocation of multiple cloud compute resources
          ignorecase: true
    - label: IAM User Access
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                accessor: name
            iscontext: true
          right:
            value:
              simple: Suspicious API call from a Tor exit node
        - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                accessor: name
            iscontext: true
          right:
            value:
              simple: Penetration testing tool activity
        - operator: isEqualString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                accessor: name
            iscontext: true
          right:
            value:
              simple: Penetration testing tool attempt
    - label: Token Theft
      condition:
      - - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of EC2 token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of VM Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of AWS Lambda’s token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of AWS Lambda’s role
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of an AWS service token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of an AWS EKS token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of an AWS EKS token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of an AWS ECS token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of an AWS ECS token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of AWS service token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of an App engine Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of VM Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of an App engine Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Suspicious usage of App engine Service Account token
          ignorecase: true
        - operator: containsGeneral
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Remote usage of VM Service Account token
          ignorecase: true
    - label: Data Exfiltration
      condition:
      - - operator: containsString
          left:
            value:
              complex:
                root: PaloAltoNetworksXDR.Incident.alerts
                accessor: name
            iscontext: true
          right:
            value:
              simple: An identity performed a suspicious download of multiple cloud storage object
    - label: Malicious Pod
      condition:
      - - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 2736470759
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 3395838097
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 4056473708
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 3906076747
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 1696441024
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 15999229
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 624304616
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 1099928083
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 779228750
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 807956875
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 3223457282
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 17641322
          ignorecase: true
        - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.name
            iscontext: true
          right:
            value:
              simple: Cryptominers Protection - 2736470759
          ignorecase: true
      - - operator: containsString
          left:
            value:
              simple: PaloAltoNetworksXDR.Incident.alerts.agent_device_domain
            iscontext: true
          right:
            value:
              simple: compute
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1580,
          "y": 560
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: afb9affe-b3de-4c89-8cd5-5c40d7e19e95
    type: playbook
    task:
      id: afb9affe-b3de-4c89-8cd5-5c40d7e19e95
      version: -1
      name: Cortex XDR - Possible External RDP Brute-Force
      description: "This playbook investigates a “Possible External RDP Brute Force” XDR Alert by gathering user, IP, and hostname information, and investigates if the following suspicious elements exists:\n- \"IP Reputation\" - Dbot Score is 2-3 \n- \"Source geolocation\" - Connection from unusual country \n-  Related to campaign - IP address related to campaign, based on TIM module\n-  Hunting results - hunt for indicators related to the source IP and the related campaign returned results\n-  XDR Alert search - XDR Alerts related to the same username and endpoint\n\nSet verdict method:\n* Suspicious Element - The \"Suspicious Element\" input allows you to select a specific element that, if identified as suspicious, the investigation's final verdict will be deemed a \"True Positive\".\n\n* Final Verdict -  Each suspicious element is being added to an array called \"Suspicious Elements\", which is used to count potential security threats. The array size will be compared to a final threshold. If the size is greater than or equal to the threshold, the investigation's final verdict will be deemed a \"True Positive\".\n\n* User Engagement - The \"UserEngagementThreshold\" input allows you to set the number of suspicious elements that trigger user engagement. When this threshold is met, an email will be sent to the user and their manager asking for authorization of RDP activity. If the RDP activity is not authorized by the user, the investigation's final verdict will be deemed a \"True Positive\".\n\nUsed Sub-playbooks:\n* Account Enrichment - Generic v2.1\n* Block Indicators - Generic v3\n* Cortex XDR - Get entity alerts by MITRE tactics - Endpoint\n* Cortex XDR - Get entity alerts by MITRE tactics - user\n* User Investigation - Generic\n* TIM - Indicator Relationships Analysis\n* Threat Hunting - Generic\n* Cortex XDR - Possible External RDP Brute Force - Set Verdict\n* Cortex XDR - Isolate Endpoint\n"
      playbookName: Cortex XDR - Possible External RDP Brute-Force
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      Alert_Name:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: name
      AlertDescription:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: description
      AutoRemediation:
        simple: "false"
      Country:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts.action_country
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
      EndpointID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: endpoint_id
      ExternalIP:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: action_local_ip
      Final_Threshold:
        simple: "3"
      Hostname:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: host_name
      IsolateEndpoint:
        simple: "false"
      Username:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: user_name
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 480,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: af704f7c-40a1-4504-8b32-a1b42466b208
    type: playbook
    task:
      id: af704f7c-40a1-4504-8b32-a1b42466b208
      version: -1
      name: Cortex XDR - First SSO Access
      description: |-
        Investigates a Cortex XDR incident containing First SSO access from ASN in an organization
         or First successful SSO connection from a country in an organization.

        The playbook executes the following:
        - IP and User Enrichment.
        - User Investigation - Using 'User Investigation - Generic' sub-playbook.
        - First SSO Access investigation - Using 'Cortex XDR - First SSO Investigation' sub-playbook.
        - Set alert's verdict - Using 'Cortex XDR - First SSO access - Set Verdict' sub-playbook.
        - Response based on the verdict.

        The playbook is used as a sub-playbook in ‘Cortex XDR Incident Handling - v3’.
      playbookName: Cortex XDR - First SSO Access
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AlertID:
        complex:
          root: inputs.alert_id
      AlertName:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: name
      AutomaticallyBlockAccount:
        simple: "False"
      AutomaticallyIsolateEndpoint:
        simple: "False"
      ContactUserManager:
        simple: "True"
      EndpointID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
              ignorecase: true
          accessor: endpoint_id
      FailedlogonFromASNThreshold:
        simple: "20"
      FailedlogonUserThreshold:
        simple: "30"
      IPAddress:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: host_ip_list
      LoginCountry:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: action_country
      NumOfXdrAlertsThreshold:
        simple: "3"
      Username:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
          accessor: user_name
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 40,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: 03d9ad54-f3f1-471c-8e9d-e23ca70bd245
    type: playbook
    task:
      id: 03d9ad54-f3f1-471c-8e9d-e23ca70bd245
      version: -1
      name: Cortex XDR - Cloud IAM User Access Investigation
      description: "Investigate and respond to Cortex XDR Cloud alerts where a Cloud IAM user`s access key is used suspiciously to access the cloud environment. \nThe following alerts are supported for AWS, Azure, and GCP environments.\n- Penetration testing tool attempt\n- Penetration testing tool activity\n- Suspicious API call from a Tor exit node\n\n"
      playbookName: Cortex XDR - Cloud IAM User Access Investigation
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AWS-accessKeyRemediationType:
        simple: Disable
      AWS-resourceRemediationType:
        simple: Stop
      AWS-userRemediationType:
        simple: Revoke
      Azure-resourceRemediationType:
        simple: Poweroff
      Azure-userRemediationType:
        simple: Disable
      GCP-accessKeyRemediationType:
        simple: Disable
      GCP-resourceRemediationType:
        simple: Stop
      GCP-userRemediationType:
        simple: Disable
      alert_id:
        complex:
          root: inputs.alert_id
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -2420,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 2
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: f1196718-45f0-40a1-8c50-bccdeab9bffa
    type: playbook
    task:
      id: f1196718-45f0-40a1-8c50-bccdeab9bffa
      version: -1
      name: Cortex XDR - XCloud Token Theft Response
      description: |-
        ---

        ## Cloud Token Theft Response Playbook

        The **Cloud Token Theft Response Playbook** provides a structured and comprehensive flow to effectively respond to and mitigate alerts involving the theft of cloud tokens. The playbook supports AWS, GCP, and Azure and executes the following:

        **Cloud Enrichment:**
        - Enriches the involved resources.
        - Enriches the involved identities.
        - Enriches the involved IPs.

        **Verdict Decision Tree:**
        - Determines the appropriate verdict based on the investigation findings.

        **Early Containment using the Cloud Response - Generic Playbook:**
        - Implements early containment measures to prevent further impact.

        **Cloud Persistence Threat Hunting:**
        - Conducts threat hunting activities to identify any cloud persistence techniques.

        **Enriching and Responding to Hunting Findings:**
        - Performs additional enrichment and responds to the findings from threat hunting.

        **Verdict Handling:**
        - Handles false positives identified during the investigation.
        - Handles true positives by initiating appropriate response actions.

        ---
      playbookName: Cortex XDR - XCloud Token Theft Response
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      InternalRange:
        complex:
          root: inputs.InternalIPRanges
      ResolveIP:
        simple: "True"
      alert_id:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: inList
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: Suspicious usage of EC2 token, Suspicious usage of VM Service Account token, Suspicious usage of AWS Lambda’s token, Suspicious usage of AWS Lambda’s role, Remote usage of an AWS service token, Remote usage of an AWS EKS token, Suspicious usage of an AWS EKS token, Suspicious usage of an AWS ECS token, Remote usage of an AWS ECS token, Suspicious usage of AWS service token, Remote usage of an App engine Service Account token, Suspicious usage of App engine Service Account token, Remote usage of VM Service Account token, Suspicious usage of VM Service Account token, Remote usage of an App engine Service Account token, Suspicious usage of App engine Service Account token
              ignorecase: true
          accessor: alert_id
      autoAccessKeyRemediation:
        simple: "False"
      autoBlockIndicators:
        simple: "False"
      autoResourceRemediation:
        simple: "False"
      autoUserRemediation:
        simple: "False"
      earlyContainment:
        simple: "False"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -2000,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: fd361936-3224-4f04-81e0-ad04bb7982a9
    type: playbook
    task:
      id: fd361936-3224-4f04-81e0-ad04bb7982a9
      version: -1
      name: Cortex XDR - Cloud Data Exfiltration Response
      playbookName: Cortex XDR - Cloud Data Exfiltration Response
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      alertID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: An identity performed a suspicious download of multiple cloud storage objects
          accessor: alert_id
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 0
    view: |-
      {
        "position": {
          "x": -2840,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "18":
    id: "18"
    taskid: 4f44cece-4ef0-420c-8c89-b36eb4ee36ff
    type: playbook
    task:
      id: 4f44cece-4ef0-420c-8c89-b36eb4ee36ff
      version: -1
      name: Cortex XDR Remote PsExec with LOLBIN command execution alert
      description: "The \"Remote PsExec-like LOLBIN Command Execution\" playbook is designed to address and respond to alerts indicating suspicious activities related to remote PsExec-like LOLBIN command execution from an unsigned non-standard source. \nThe playbook aims to efficiently:\n\n- Get the alert data and check if the execution is blocked. If not will terminate the process (manually by default).\n- Enrich any entities and indicators from the alert and find any related campaigns.\n- Perform command analysis to provide insights and a verdict for the executed command.\n- Perform further endpoint investigation using Cortex XDR.\n- Checks for any malicious verdicts found to raise the severity of the alert.\n- Perform automatic/manual remediation response by blocking any malicious indicators found.\n\nThe playbook is designed to run as a sub-playbook in ‘Cortex XDR Incident Handling - v3 & Cortex XDR Alerts Handling’.\nIt depends on the data from the parent playbooks and cannot be used as a standalone version."
      playbookName: Cortex XDR Remote PsExec with LOLBIN command execution alert
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AutoRemediation:
        simple: "false"
      CriticalAlertsThreshold:
        simple: "1"
      EndpointIDs:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: containsString
              left:
                value:
                  simple: incident.xdralerts.name
                iscontext: true
              right:
                value:
                  simple: Remote PsExec-like LOLBIN command execution from an unsigned
              ignorecase: true
          accessor: endpoint_id
      HighAlertsThreshold:
        simple: "1"
      LOLBASFeedLimit:
        simple: "100"
      SrcIPAddress:
        complex:
          root: incident.xdralerts
          accessor: actionremoteip
          transformers:
          - operator: uniq
      alerts_ids:
        complex:
          root: incident.xdralerts
          filters:
          - - operator: containsString
              left:
                value:
                  simple: incident.xdralerts.name
                iscontext: true
              right:
                value:
                  simple: Remote PsExec-like LOLBIN command execution from an unsigned
              ignorecase: true
          accessor: alert_id
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1360,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "19":
    id: "19"
    taskid: a654adf8-a78a-4d1c-8fb3-1e4964634acd
    type: playbook
    task:
      id: a654adf8-a78a-4d1c-8fb3-1e4964634acd
      version: -1
      name: Cortex XDR - Identity Analytics
      description: |
        The `Cortex XDR - Identity Analytics` playbook is designed to handle Cortex XDR Identity Analytics alerts and executes the following:

        Analysis:
        - Enriches the IP address and the account, providing additional context and information about these indicators.

        Verdict:
        - Determines the appropriate verdict based on the data collected from the enrichment phase.

        Investigation:
        - Checks for related Cortex XDR alerts to the user by Mitre tactics to identify malicious activity.
        - Checks for specific arguments for malicious usage from Okta using the 'Okta User Investigation' sub-playbook.
        - Checks for specific arguments for malicious usage from Azure using the 'Azure User Investigation' sub-playbook.

        Verdict Handling:
        - Handles malicious alerts by initiating appropriate response actions, including blocking malicious IP addresses and revoking or clearing user's sessions.
        - Handles non-malicious alerts identified during the investigation.

        The playbook is used as a sub-playbook in ‘Cortex XDR Alerts Handling v2’.
      playbookName: Cortex XDR - Identity Analytics
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AlertName:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: name
      AutoRemediation:
        simple: "False"
      FailedLogonThreshold:
        simple: "30"
      IAMRemediationType:
        simple: Revoke
      IPAddress:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: host_ip_list
      OktaSuspiciousEventsThreshold:
        simple: "5"
      RelatedAlertsThreshold:
        simple: "5"
      Username:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: user_name
      alert_id:
        simple: ${inputs.alert_id}
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -400,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "20":
    id: "20"
    taskid: a5d6b026-ceeb-4fa1-89eb-87738d057e70
    type: playbook
    task:
      id: a5d6b026-ceeb-4fa1-89eb-87738d057e70
      version: -1
      name: Cortex XDR - Large Upload
      description: "The playbook investigates Cortex XDR incidents involving large upload alerts. The playbook is designed to run as a sub-playbook of ‘Cortex XDR Alerts Handling v2’. \n\nThe playbook consists of the following procedures:\n- Searches for similar previous incidents that were closed as false positives.\n- Enrichment and investigation of the initiator and destination hostname and IP address.\n- Enrichment and investigation of the initiator user, process, file, or command if it exists.\n- Detection of related indicators and analysis of the relationship between the detected indicators.\n- Utilize the detected indicators to conduct threat hunting.\n- Blocks detected malicious indicators.\n- Endpoint isolation.\n\nThis playbook supports the following Cortex XDR alert names:\n- Large Upload (Generic)\n- Large Upload (SMTP)\n- Large Upload (FTP)\n- Large Upload (HTTPS)"
      playbookName: Cortex XDR - Large Upload
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      Alert_ID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: Large Upload
              ignorecase: true
          accessor: alert_id
          transformers:
          - operator: uniq
      AutoBlockIndicators:
        simple: "True"
      AutoIsolateEndpoint:
        simple: "False"
      BlockIndicators_UserVerification:
        simple: "False"
      EarlyContainment:
        simple: "True"
      FWApps_Processes_Whitlist:
        simple: ip,tcp,udp,ssl,syslog,quic,Chrome.exe,Firefox.exe,Opera.exe,Safari.exe,iexplore.exe,msedge.exe,brave.exe
      FurtherInvestigation:
        simple: "False"
      InternalIPRanges:
        complex:
          root: inputs.InternalIPRanges
      Transferred_Data _Threshold:
        simple: "150"
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 1800,
          "y": 395
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "21":
    id: "21"
    taskid: 5117b380-1718-4d1e-8e24-9e073ec05c99
    type: regular
    task:
      id: 5117b380-1718-4d1e-8e24-9e073ec05c99
      version: -1
      name: Set Alert ID to continue with the investigation and response
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: ContinueResponseForAlerts
      value:
        simple: ${inputs.alert_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 2670,
          "y": 570
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: add38fdf-2c25-4a46-8962-5fa3f1fe0376
    type: regular
    task:
      id: add38fdf-2c25-4a46-8962-5fa3f1fe0376
      version: -1
      name: Set Alert ID to continue with the investigation and response
      description: Set a value in context under the key you entered.
      scriptName: Set
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: ContinueResponseForAlerts
      value:
        simple: ${inputs.alert_id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": -1160,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "23":
    id: "23"
    taskid: b2cbbb68-dc6d-427b-83db-170c4c57b546
    type: playbook
    task:
      id: b2cbbb68-dc6d-427b-83db-170c4c57b546
      version: -1
      name: Cortex XDR - Malicious Pod Response - Agent
      description: "This playbook ensures a swift and effective response to malicious activities within Kubernetes environments, leveraging cloud-native tools to maintain cluster security and integrity.\n\nThe playbook is designed to handle agent-generated alerts due to malicious activities within Kubernetes (K8S) pods, such as mining activities, which requires immediate action. The playbook also addresses scenarios where the malicious pod is killed, but the malicious K8S workload repeatedly creates new pods.\n\nKey Features:\n\n1. Trigger: The playbook is activated when an agent-based mining alert is detected within a Kubernetes pod.\n2. AWS Function Integration: Utilizes an AWS Lambda function to facilitate rapid response actions.\n3. K8S Environment Remediation: \n    - Pod Termination: The playbook includes steps to terminate the affected pod within the K8S environment safely.\n    - Workload Suspension: If necessary, the playbook can be escalated to suspend the entire workload associated with the mining activity.\n\nWorkflow:\n\n1. Alert Detection: The playbook begins with the monitoring agent detecting a mining alert within a Kubernetes pod.\n2. Alert Validation: Validates the alert to ensure it is not a false positive.\n3. Response Decision: \n    - Pod Termination: If the mining activity is isolated to a single pod, the AWS Lambda function is invoked to terminate the affected pod within the K8S environment.\n    - Workload Suspension: If the mining activity is widespread or poses a significant threat, the AWS Lambda function suspends the entire workload within the K8S environment.\n4. Cleanup: Initiates a complete removal of all objects created for the Lambda execution for security and hardening purposes."
      playbookName: Cortex XDR - Malicious Pod Response - Agent
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AlerID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: containsGeneral
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.name
                iscontext: true
              right:
                value:
                  simple: Cryptominers Protection
              ignorecase: true
          accessor: alert_id
      ClusterName:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: cluster_name
          transformers:
          - operator: uniq
      Region:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          accessor: agent_device_domain
          transformers:
          - operator: Cut
            args:
              delimiter:
                value:
                  simple: .
              fields:
                value:
                  simple: "1"
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -3260,
          "y": 750
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "24":
    id: "24"
    taskid: f9470421-ccd1-4c14-8792-9af82e7cc0a5
    type: playbook
    task:
      id: f9470421-ccd1-4c14-8792-9af82e7cc0a5
      version: -1
      name: Cortex XDR - T1036 - Masquerading
      description: |-
        This playbook handles masquerading alerts based on the MITRE T1036 technique.
        An attacker might leverage Microsoft Windows' well-known image names to run malicious processes without being caught.

        **Attacker's Goals:**

        An attacker attempts to masquerade as standard Windows images by using a trusted name to execute malicious code.

        **Investigative Actions:**

        Enrich and Investigate the executed process image and endpoint and verify if it is malicious using:

        * File Reputation
        * NSRL DB
        * CommandLine Analysis
        * Related Alerts


        **Response Actions**

        When the playbook executes, it checks for additional activity, and if a malicious behavior is found, the playbook proceeds with containment actions:

        * Auto Process termination
        * Auto file quarantine
        * Manual containment

        External resources:

        [MITRE Technique T1036](https://attack.mitre.org/techniques/T1036/)

        [Possible Microsoft process masquerading](https://docs-cortex.paloaltonetworks.com/r/Cortex-XDR-Analytics-Alert-Reference/Possible-Microsoft-process-masquerading)
      playbookName: Cortex XDR - T1036 - Masquerading
      type: playbook
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "5"
    scriptarguments:
      AlertID:
        complex:
          root: inputs.alert_id
          transformers:
          - operator: uniq
      AutoContainment:
        simple: "False"
      EndpointID:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: endpoint_id
          transformers:
          - operator: uniq
      FilePath:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.alert_id
                iscontext: true
              right:
                value:
                  simple: inputs.alert_id
                iscontext: true
              ignorecase: true
          accessor: actor_process_image_path
          transformers:
          - operator: uniq
      FileSHA256:
        complex:
          root: PaloAltoNetworksXDR.Incident.alerts
          filters:
          - - operator: containsString
              left:
                value:
                  simple: PaloAltoNetworksXDR.Incident.alerts.mitre_technique_id_and_name
                iscontext: true
              right:
                value:
                  simple: T1036
              ignorecase: true
          accessor: actor_process_image_sha256
          transformers:
          - operator: uniq
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": -980,
          "y": 405
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "12_15_IAM User Access": 0.84,
      "12_16_Token Theft": 0.65,
      "12_17_Data Exfiltration": 0.9,
      "1_11_Cloud": 0.9,
      "1_14_First SSO Access": 0.86,
      "1_18_ Remote PsExec with LOLBIN command": 0.67,
      "1_19_Identity Analytics": 0.9,
      "1_20_Large Upload": 0.89,
      "1_24_Masquerading": 0.81,
      "1_7_#default#": 0.9
    },
    "paper": {
      "dimensions": {
        "height": 915,
        "width": 6310,
        "x": -3260,
        "y": 80
      }
    }
  }
inputs:
- key: incident_id
  value:
    complex:
      root: PaloAltoNetworksXDR
      accessor: Incident.incident_id
  required: false
  description: Incident ID.
  playbookInputQuery:
- key: alert_id
  value:
    complex:
      root: PaloAltoNetworksXDR.Incident.alerts
      accessor: alert_id
  required: false
  description: Alert ID.
  playbookInputQuery:
- key: InternalIPRanges
  value:
    complex:
      root: lists
      accessor: PrivateIPs
      transformers:
      - operator: RegexReplace
        args:
          action_dt: {}
          ignore_case: {}
          multi_line: {}
          output_format: {}
          period_matches_newline: {}
          regex:
            value:
              simple: IANA_Private_Address
  required: false
  description: 'A list of IP ranges to check the IP against. The list should be provided in CIDR notation, separated by commas. An example of a list of ranges would be: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16" (without quotes). If a list is not provided, will use default list provided in the IsIPInRanges script (the known IPv4 private address ranges).'
  playbookInputQuery:
outputs: []
tests:
- Test XDR Playbook
fromversion: 6.5.0
marketplaces:
- xsoar
