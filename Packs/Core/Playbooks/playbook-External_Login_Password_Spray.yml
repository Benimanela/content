id: External Login Password Spray
version: -1
name: External Login Password Spray
description: |-
  This playbook investigates and responds to external login password sprays. It starts by enriching the external IP, allowing early containment. It then fetches event information to learn more about the attack - how it was executed and whether it succeeded or not.
  For remediation, the playbook checks for RemoteInteractive (RDP) sessions to close, and allows the analyst to expire the password of any users that successfully logged in as part of the attack.
tags:
- T1110
- Brute Force
starttaskid: "0"
tasks:
  "0":
    id: "0"
    taskid: 5b3b36a9-54de-46e5-8d25-977a87925b85
    type: start
    task:
      id: 5b3b36a9-54de-46e5-8d25-977a87925b85
      version: -1
      name: ""
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "16"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -440
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "10":
    id: "10"
    taskid: 2c5f9abc-b170-475e-87a0-4c4508edd8ee
    type: condition
    task:
      id: 2c5f9abc-b170-475e-87a0-4c4508edd8ee
      version: -1
      name: Any users require hard remediation?
      description: "Checks whether hard remediation should be performed. \n\nTo perform hard remediation, all of the following conditions have to be met:\n\n1. At least one user logged in successfully.\n2. At least of the above users has a High risk level (available with ITDR license).\n3. The interval analysis suggests automation was used OR the failed logon attempts exceeded the baseline for the host.\n4. The alert severity is Medium or above."
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "Yes":
      - "41"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: RiskyLogonUsernames
            iscontext: true
          right:
            value: {}
      - - operator: isTrue
          left:
            value:
              simple: IntervalAnalysis.IsPatternLikelyAutomated
            iscontext: true
        - operator: isTrue
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.is_count_failed_users_above_baseline
            iscontext: true
      - - operator: greaterThanOrEqual
          left:
            value:
              simple: alert.severity
            iscontext: true
          right:
            value:
              simple: "2"
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 160,
          "y": 1920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "12":
    id: "12"
    taskid: 8f797988-bfc5-48bc-87a7-1b5ec4469f18
    type: regular
    task:
      id: 8f797988-bfc5-48bc-87a7-1b5ec4469f18
      version: -1
      name: Analyze intervals of login attempts
      description: Analyzes the timestamps of the logon events, to detect simple patterns of consistency or high frequency.
      scriptName: AnalyzeTimestampIntervals
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      timestamps:
        simple: ${Core.OriginalAlert._all_events.event_timestamp}
      verbose:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 180,
          "y": 1160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "13":
    id: "13"
    taskid: 64b2ac11-b9d3-422d-8ec1-bc4e1851228b
    type: regular
    task:
      id: 64b2ac11-b9d3-422d-8ec1-bc4e1851228b
      version: -1
      name: Save all usernames that logged in successfully
      description: Saves the users that logged in successfully in a new context key.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "17"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: SuccessfulLoginUsernames
      value:
        complex:
          root: Core.OriginalAlert._all_events
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.OriginalAlert._all_events.outcome
                iscontext: true
              right:
                value:
                  simple: SUCCESS
              ignorecase: true
          accessor: dst_identity
          transformers:
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 845
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    fieldMapping:
    - incidentfield: Affected Users
      output:
        complex:
          root: |2-

            Core.OriginalAlert._all_events
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: |2-

                    Core.OriginalAlert._all_events.outcome
                iscontext: true
              right:
                value:
                  simple: SUCCESS
              ignorecase: true
          accessor: dst_identity
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "14":
    id: "14"
    taskid: 249048f3-255d-46ae-8f9b-17cbeb9b41a6
    type: condition
    task:
      id: 249048f3-255d-46ae-8f9b-17cbeb9b41a6
      version: -1
      name: Any successful logins?
      description: Checks whether any logon attempt was successful.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "22"
      "Yes":
      - "28"
      - "59"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: SuccessfulLoginUsernames
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1160
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "15":
    id: "15"
    taskid: a3265e65-9c71-49d5-8083-f99a6e850cd9
    type: regular
    task:
      id: a3265e65-9c71-49d5-8083-f99a6e850cd9
      version: -1
      name: Get more information about the logon events
      description: Returns information about each alert ID.
      script: '|||core-get-cloud-original-alerts'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "13"
    scriptarguments:
      alert_ids:
        simple: ${alert.id}
      filter_alert_fields:
        simple: "false"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 670
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "16":
    id: "16"
    taskid: 8b16799b-7a3a-4cff-81c7-daa45dd09f54
    type: title
    task:
      id: 8b16799b-7a3a-4cff-81c7-daa45dd09f54
      version: -1
      name: Triage
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "45"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -290
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "17":
    id: "17"
    taskid: f7b61352-1377-4bf8-8cd1-bb769476a36e
    type: title
    task:
      id: f7b61352-1377-4bf8-8cd1-bb769476a36e
      version: -1
      name: Investigation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "14"
      - "12"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 1010
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "22":
    id: "22"
    taskid: fcc95117-cf0a-4dfa-8c1c-4686e81b49fe
    type: title
    task:
      id: fcc95117-cf0a-4dfa-8c1c-4686e81b49fe
      version: -1
      name: Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "10"
      - "50"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 470,
          "y": 1745
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "28":
    id: "28"
    taskid: ab9e8890-5b6a-4dc4-8299-9bb437364438
    type: regular
    task:
      id: ab9e8890-5b6a-4dc4-8299-9bb437364438
      version: -1
      name: Get user risk score of logged in users
      description: Gets the risk score of the users that successfully logged in.
      script: '|||core-list-risky-users'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "31"
    scriptarguments:
      user_id:
        simple: ${SuccessfulLoginUsernames}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "31":
    id: "31"
    taskid: d95dbf97-5bb9-4ca9-823c-0695a1420f54
    type: regular
    task:
      id: d95dbf97-5bb9-4ca9-823c-0695a1420f54
      version: -1
      name: Save risky users that logged in (if exist)
      description: Saves a separate list of users who successfully logged on as part of the attack, and were found risky.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      key:
        simple: RiskyLogonUsernames
      value:
        complex:
          root: Core.RiskyUser
          filters:
          - - operator: isEqualString
              left:
                value:
                  simple: Core.RiskyUser.risk_level
                iscontext: true
              right:
                value:
                  simple: HIGH
          accessor: id
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 710,
          "y": 1520
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "33":
    id: "33"
    taskid: 24dbf75b-e52b-4032-8786-2ad0d2749207
    type: regular
    task:
      id: 24dbf75b-e52b-4032-8786-2ad0d2749207
      version: -1
      name: Close alert
      description: Close the current alert.
      script: Builtin|||closeInvestigation
      type: regular
      iscommand: true
      brand: Builtin
    scriptarguments:
      id:
        simple: ${alert.id}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 470,
          "y": 3240
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "39":
    id: "39"
    taskid: 19528476-25f9-4e0a-8827-107e4b0e45e0
    type: title
    task:
      id: 19528476-25f9-4e0a-8827-107e4b0e45e0
      version: -1
      name: Soft Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "63"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 2140
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "41":
    id: "41"
    taskid: f1633e74-6dbb-453d-8490-b6679b6227b5
    type: title
    task:
      id: f1633e74-6dbb-453d-8490-b6679b6227b5
      version: -1
      name: Hard Remediation
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "81"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 40,
          "y": 2130
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "45":
    id: "45"
    taskid: 119f0216-cd78-4fbc-81d8-3fc9e075d9fa
    type: regular
    task:
      id: 119f0216-cd78-4fbc-81d8-3fc9e075d9fa
      version: -1
      name: Check reputation of Source IP
      description: Enriches the external source IP of the attack to check if it's known as malicious. Skips on errors for cases where the IP address or the !ip command is empty.
      script: '|||ip'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "46"
    scriptarguments:
      ip:
        simple: ${alert.localip}
    reputationcalc: 2
    separatecontext: false
    continueonerror: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": -155
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "46":
    id: "46"
    taskid: a1924082-41b3-47f8-8766-d268b29a9658
    type: condition
    task:
      id: a1924082-41b3-47f8-8766-d268b29a9658
      version: -1
      name: Is the IP malicious?
      description: Checks if the external Source IP is malicious (DBotScore above 2).
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      "Yes":
      - "47"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: DBotScore
                filters:
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Type
                      iscontext: true
                    right:
                      value:
                        simple: ip
                - - operator: greaterThan
                    left:
                      value:
                        simple: DBotScore.Score
                      iscontext: true
                    right:
                      value:
                        simple: "2"
                - - operator: isEqualString
                    left:
                      value:
                        simple: DBotScore.Indicator
                      iscontext: true
                    right:
                      value:
                        simple: alert.localip.[0]
                      iscontext: true
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 450,
          "y": 5
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "47":
    id: "47"
    taskid: 2ef06d13-aafd-4c49-8ad7-9a310e53e5bd
    type: title
    task:
      id: 2ef06d13-aafd-4c49-8ad7-9a310e53e5bd
      version: -1
      name: Early Containment
      type: title
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "48"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 120,
          "y": 180
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "48":
    id: "48"
    taskid: 8d84ddf8-0cbe-4578-83e3-6d9caf7df505
    type: condition
    task:
      id: 8d84ddf8-0cbe-4578-83e3-6d9caf7df505
      version: -1
      name: Manual - block the source IP?
      description: |-
        The following IP was detected as malicious: ${alert.localip.[0]}
        Would you like to block it?
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "15"
      "Yes":
      - "84"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 120,
          "y": 310
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "50":
    id: "50"
    taskid: b50ca2c1-88ad-4d10-8940-1c387d95420e
    type: condition
    task:
      id: b50ca2c1-88ad-4d10-8940-1c387d95420e
      version: -1
      name: Any users require soft remediation?
      description: "Checks whether soft remediation should be performed. \n\nTo perform soft remediation, all of the following conditions have to be met:\n\n1. At least one user logged in successfully.\n2. The interval analysis suggests automation was used OR the failed logon attempts exceeded the baseline for the host.\n"
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "Yes":
      - "39"
    separatecontext: false
    conditions:
    - label: "Yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              simple: UsersToDisconnect
            iscontext: true
          right:
            value: {}
      - - operator: isTrue
          left:
            value:
              simple: IntervalAnalysis.IsPatternLikelyAutomated
            iscontext: true
        - operator: isTrue
          left:
            value:
              simple: Core.OriginalAlert.stateful_raw_data.is_count_failed_users_above_baseline
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 730,
          "y": 1920
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "59":
    id: "59"
    taskid: df38478e-ae21-469c-8454-bd65afc04aeb
    type: regular
    task:
      id: df38478e-ae21-469c-8454-bd65afc04aeb
      version: -1
      name: Prepare list of usernames for soft remediation
      description: Saves a general list of all the users that will require soft remediation. Specific types of remediation may need the names to appear in different structures or syntax.
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "22"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: UsersToDisconnect
      value:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: replace
            args:
              limit: {}
              replaceWith:
                value:
                  simple: \
              toReplace:
                value:
                  simple: \\
          - operator: concat
            args:
              prefix:
                value:
                  simple: ''''
              suffix:
                value:
                  simple: ''''
          - operator: join
            args:
              separator:
                value:
                  simple: ','
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1150,
          "y": 1360
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "63":
    id: "63"
    taskid: 34b3eb95-9bb9-46cf-8bae-dcc640a0aee2
    type: condition
    task:
      id: 34b3eb95-9bb9-46cf-8bae-dcc640a0aee2
      version: -1
      name: What OS is running on the host?
      description: Checks if the operating system reported by the agent of the machine to which the users logged in is Windows or another OS.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "78"
      Windows:
      - "65"
    separatecontext: false
    conditions:
    - label: Windows
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: alert
                accessor: hostos
                transformers:
                - operator: uniq
                - operator: FirstArrayElement
            iscontext: true
          right:
            value:
              simple: AGENT_OS_WINDOWS
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 2265
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "65":
    id: "65"
    taskid: f7be4f31-ed7e-4744-82c2-9a62543b2789
    type: condition
    task:
      id: f7be4f31-ed7e-4744-82c2-9a62543b2789
      version: -1
      name: What logon type was used?
      description: Checks the logon type (E.g., Network, RemoteInteractive, etc) used in the attack.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "78"
      RemoteInteractive:
      - "73"
    separatecontext: false
    conditions:
    - label: RemoteInteractive
      condition:
      - - operator: isEqualString
          left:
            value:
              complex:
                root: Core.OriginalAlert._all_events.login_data
                accessor: type
                transformers:
                - operator: uniq
                - operator: FirstArrayElement
            iscontext: true
          right:
            value:
              simple: RemoteInteractive
          ignorecase: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 920,
          "y": 2460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "67":
    id: "67"
    taskid: 868e45e4-7156-42ff-8e69-98cdd60d2a07
    type: regular
    task:
      id: 868e45e4-7156-42ff-8e69-98cdd60d2a07
      version: -1
      name: Terminate RDP Session
      description: Initiates a shell command that runs a Powershell script. The script checks for active user sessions and terminates them in order to logoff offending users during interactive sessions.
      script: '|||core-run-script-execute-commands'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      commands:
        complex:
          root: RDPLogoffUsers
          transformers:
          - operator: concat
            args:
              prefix:
                value:
                  simple: powershell -Command "$users = @(
              suffix:
                value:
                  simple: ) -split ';'; query user | Select-Object -Skip 1 | ForEach-Object { $sessionInfo = $_ -split '\s+' | Where-Object { $_ -ne '' -and $_ -notlike 'Disc' }; if ($sessionInfo.Length -ge 6) { $username = $sessionInfo[0].TrimStart('>'); $sessionId = $sessionInfo[2]; if ($users -contains $username) { logoff $sessionId } } }"
      endpoint_ids:
        simple: ${alert.agentid}
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 700,
          "y": 2860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "73":
    id: "73"
    taskid: dec69d00-80fb-4610-890a-24d390dd4b82
    type: regular
    task:
      id: dec69d00-80fb-4610-890a-24d390dd4b82
      version: -1
      name: Prepare list of users for RDP session termination
      description: |-
        Set a value in context under the key you entered. If no value is entered, the script doesn't do anything.

        This automation runs using the default Limited User role, unless you explicitly change the permissions.
        For more information, see the section about permissions here:
        https://docs-cortex.paloaltonetworks.com/r/Cortex-XSOAR/6.10/Cortex-XSOAR-Administrator-Guide/Automations
      scriptName: SetAndHandleEmpty
      type: regular
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "67"
    scriptarguments:
      append:
        simple: "true"
      key:
        simple: RDPLogoffUsers
      value:
        complex:
          root: SuccessfulLoginUsernames
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?:\\+)(.*)
              unpack_matches: {}
          - operator: join
            args:
              separator:
                value:
                  simple: ;
          - operator: concat
            args:
              prefix:
                value:
                  simple: ''''
              suffix:
                value:
                  simple: ''''
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 700,
          "y": 2680
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "78":
    id: "78"
    taskid: dadbe726-b65e-4c7d-8ef6-4016236c2565
    type: collection
    task:
      id: dadbe726-b65e-4c7d-8ef6-4016236c2565
      version: -1
      name: Choose users whose passwords will be expired
      description: Asks the analyst to choose users whose passwords will be expired in Active Directory.
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "80"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 2680
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Choose users for which to expire passwords.
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: SuccessfulLoginUsernames
            transformers:
            - operator: uniq
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Password Expiration - Logged-on Users
      description: Decide whether the password should be expired for users who have successfully logged in.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "79":
    id: "79"
    taskid: 4448291d-c8f3-4cd2-83d3-6da0d96e5f9e
    type: regular
    task:
      id: 4448291d-c8f3-4cd2-83d3-6da0d96e5f9e
      version: -1
      name: Expire the user passwords
      description: Expires the passwords of the selected users.
      script: '|||ad-expire-password'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      username:
        complex:
          root: Password Expiration - Logged-on Users.Answers
          accessor: "0"
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?:\\+)(.*)
              unpack_matches: {}
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 3040
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "80":
    id: "80"
    taskid: 00616139-7920-4034-86bf-33d4fd50e343
    type: condition
    task:
      id: 00616139-7920-4034-86bf-33d4fd50e343
      version: -1
      name: Was any user selected?
      description: Checks whether any user was selected for password expiration.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "79"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Password Expiration - Logged-on Users.Answers
                accessor: "0"
                transformers:
                - operator: uniq
            iscontext: true
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 1230,
          "y": 2860
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "81":
    id: "81"
    taskid: 1a4db1bf-2951-49ce-8054-2dbf6ef1be99
    type: collection
    task:
      id: 1a4db1bf-2951-49ce-8054-2dbf6ef1be99
      version: -1
      name: Choose risky users for password expiration
      description: Asks the analyst to choose users whose passwords will be expired.
      type: collection
      iscommand: false
      brand: ""
    nexttasks:
      '#none#':
      - "83"
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 40,
          "y": 2265
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    message:
      to:
      subject:
      body:
      methods: []
      format: ""
      bcc:
      cc:
      timings:
        retriescount: 2
        retriesinterval: 360
        completeafterreplies: 1
        completeafterv2: true
        completeaftersla: false
    form:
      questions:
      - id: "0"
        label: ""
        labelarg:
          simple: Choose the risky users whose passwords will be expired.
        required: false
        gridcolumns: []
        defaultrows: []
        type: multiSelect
        options: []
        optionsarg:
        - complex:
            root: RiskyLogonUsernames
            transformers:
            - operator: uniq
        fieldassociated: ""
        placeholder: ""
        tooltip: ""
        readonly: false
      title: Password Expiration - Risky Users
      description: Decide whether the password should be expired for users who have successfully logged in.
      sender: ""
      expired: false
      totalanswers: 0
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "82":
    id: "82"
    taskid: ebe88a21-e8d6-4a9b-8906-33ad6aabb832
    type: regular
    task:
      id: ebe88a21-e8d6-4a9b-8906-33ad6aabb832
      version: -1
      name: Expire the user passwords
      description: Expires the passwords of the selected risky users.
      script: '|||ad-expire-password'
      type: regular
      iscommand: true
      brand: ""
    nexttasks:
      '#none#':
      - "33"
    scriptarguments:
      username:
        complex:
          root: Password Expiration - Risky Users.Answers
          accessor: "0"
          transformers:
          - operator: RegexExtractAll
            args:
              error_if_no_match: {}
              ignore_case: {}
              multi_line: {}
              period_matches_newline: {}
              regex:
                value:
                  simple: (?:\\+)(.*)
              unpack_matches: {}
          - operator: uniq
    separatecontext: false
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 40,
          "y": 2650
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: true
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "83":
    id: "83"
    taskid: df8dec46-2cf0-4e44-862d-7fa7be602027
    type: condition
    task:
      id: df8dec46-2cf0-4e44-862d-7fa7be602027
      version: -1
      name: Was any user selected?
      description: Checks whether any user was selected for password expiration.
      type: condition
      iscommand: false
      brand: ""
    nexttasks:
      '#default#':
      - "33"
      "yes":
      - "82"
    separatecontext: false
    conditions:
    - label: "yes"
      condition:
      - - operator: isNotEmpty
          left:
            value:
              complex:
                root: Password Expiration - Risky Users.Answers
                accessor: "0"
                transformers:
                - operator: uniq
            iscontext: true
          right:
            value: {}
    continueonerrortype: ""
    view: |-
      {
        "position": {
          "x": 40,
          "y": 2460
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
  "84":
    id: "84"
    taskid: 59ef6757-3ee1-4247-840c-9541b8f9a29e
    type: playbook
    task:
      id: 59ef6757-3ee1-4247-840c-9541b8f9a29e
      version: -1
      name: PAN-OS - Block IP
      playbookName: PAN-OS - Block IP
      type: playbook
      iscommand: false
      brand: ""
      description: ''
    nexttasks:
      '#none#':
      - "15"
    scriptarguments:
      MaliciousIPs:
        complex:
          root: alert
          accessor: localip
          transformers:
          - operator: uniq
          - operator: FirstArrayElement
    separatecontext: true
    continueonerrortype: ""
    loop:
      iscommand: false
      exitCondition: ""
      wait: 1
      max: 100
    view: |-
      {
        "position": {
          "x": 120,
          "y": 500
        }
      }
    note: false
    timertriggers: []
    ignoreworker: false
    skipunavailable: false
    quietmode: 0
    isoversize: false
    isautoswitchedtoquietmode: false
view: |-
  {
    "linkLabelsPosition": {
      "10_33_#default#": 0.22,
      "10_41_Yes": 0.34,
      "46_15_#default#": 0.32,
      "48_15_#default#": 0.35,
      "48_84_Yes": 0.48,
      "50_33_#default#": 0.13,
      "50_39_Yes": 0.21,
      "63_65_Windows": 0.52,
      "63_78_#default#": 0.54,
      "65_78_#default#": 0.55,
      "83_33_#default#": 0.27
    },
    "paper": {
      "dimensions": {
        "height": 3775,
        "width": 1570,
        "x": 40,
        "y": -440
      }
    }
  }
inputs: []
outputs: []
tests:
- Test Playbook - IOC Alert
- Test Playbook - Identity Analytics - Alert Handling
- Test Playbook - Impossible Traveler - Enrichment
fromversion: 6.10.0
